# On-Chain Proof Layer Implementation Summary

This document summarizes the implementation of the on-chain proof layer for the ARC payment gateway.

## Overview

The on-chain proof layer adds two main features:
1. **Merchant Badge SBT** - Non-transferable badges for verified merchants
2. **Invoice Payment Proof** - On-chain records of payment receipts

## Part 1: Merchant Badge SBT

### Smart Contract
- **File**: `contracts/MerchantBadge.sol`
- **Type**: ERC-721 (non-transferable/Soulbound)
- **Features**:
  - One badge per wallet address
  - Non-transferable (all transfer functions reverted)
  - Public minting (wallet signs transaction)
  - Emits `MerchantBadgeMinted` event

### Database Schema
- **Table**: `merchant_badges`
- **Fields**: `id`, `merchantId`, `tokenId`, `mintTxHash`, `createdAt`

### Backend API
- `GET /api/badges/status` - Get badge status (not_eligible, eligible, claimed)
- `GET /api/badges/eligibility` - Check eligibility
- `POST /api/badges/record-mint` - Record badge mint after on-chain transaction

### Frontend Integration
- **Component**: `MerchantBadgeClaim` in `client/src/components/MerchantBadgeClaim.tsx`
- **Location**: Dashboard Settings page
- **Features**:
  - Shows badge status
  - "Claim Verified Merchant Badge" button when eligible
  - Displays badge info when claimed
  - Links to explorer for mint transaction

### Eligibility Criteria
- Merchant must have at least one **confirmed** payment

## Part 2: Invoice Payment Proof Contract

### Smart Contract
- **File**: `contracts/InvoicePaymentProof.sol`
- **Features**:
  - Write-once per invoiceHash
  - Stores: invoiceHash, merchant, amount, currency, paidTxHash, timestamp
  - No funds handled
  - Emits `InvoicePaid` event

### Database Schema
- **Table**: `payment_proofs`
- **Fields**: `id`, `paymentId`, `invoiceHash`, `proofTxHash`, `createdAt`

### Backend API
- `GET /api/payments/:id/proof` - Get proof status
- `POST /api/payments/:id/generate-invoice-hash` - Generate invoice hash
- `POST /api/payments/:id/record-proof` - Record proof after on-chain transaction

### Frontend Integration
- **Component**: `PaymentProofRecord` in `client/src/components/PaymentProofRecord.tsx`
- **Location**: Payment Details page (for confirmed payments)
- **Features**:
  - "Record On-chain Receipt" button
  - Shows proof status when recorded
  - Links to explorer for proof transaction

### Invoice Hash Generation
- Formula: `keccak256(paymentId + merchantWallet + amount)`
- Generated by backend before recording

## Part 3: Dashboard Integration

### Badge Status Display
- **Location**: Dashboard Settings page
- Shows: Not Eligible / Eligible to Claim / Claimed
- Displays token ID and explorer link when claimed

### Payment Proof Status
- **Payment Details Page**: Shows proof recording component for confirmed payments
- **Payments Table**: New "Receipt" column showing:
  - "Pending" for confirmed payments without proof
  - "On-chain" with icon for payments with proof
  - "-" for non-confirmed payments

## Configuration

### Environment Variables

#### Server (`server/.env`):
```env
MERCHANT_BADGE_ADDRESS=0x...
INVOICE_PAYMENT_PROOF_ADDRESS=0x...
```

#### Client (`client/.env`):
```env
VITE_MERCHANT_BADGE_ADDRESS=0x...
VITE_INVOICE_PAYMENT_PROOF_ADDRESS=0x...
```

### ABI Files
- `contracts/MerchantBadge.abi.json`
- `contracts/InvoicePaymentProof.abi.json`

ABIs are automatically loaded from files if not set in environment variables.

## Deployment

See `CONTRACT_DEPLOYMENT.md` for detailed deployment instructions.

## Security Notes

1. **Gateway Never Signs Transactions** - All contract interactions require wallet signature
2. **Gateway Never Holds Funds** - Contracts handle no funds
3. **Backend Only Verifies** - Backend checks eligibility but doesn't enforce on-chain
4. **Non-Custodial** - All wallet operations are user-controlled

## Architecture Compliance

✅ No changes to existing payment flow
✅ No changes to UI layout/styles (only additive)
✅ No migration to Next.js
✅ Gateway never signs transactions
✅ Gateway never holds funds
✅ All interactions require wallet signature
✅ Backend only verifies eligibility

## Files Created/Modified

### New Files
- `contracts/MerchantBadge.sol`
- `contracts/MerchantBadge.abi.json`
- `contracts/InvoicePaymentProof.sol`
- `contracts/InvoicePaymentProof.abi.json`
- `server/services/badgeService.ts`
- `server/services/proofService.ts`
- `server/routes/badges.ts`
- `server/routes/proofs.ts`
- `client/src/components/MerchantBadgeClaim.tsx`
- `client/src/components/PaymentProofRecord.tsx`
- `CONTRACT_DEPLOYMENT.md`
- `ON_CHAIN_PROOF_LAYER_IMPLEMENTATION.md`

### Modified Files
- `shared/schema.ts` - Added `merchantBadges` and `paymentProofs` tables
- `server/config.ts` - Added contract addresses and ABI loading
- `server/storage.ts` - Added badge and proof storage methods
- `server/routes.ts` - Registered new routes
- `client/src/pages/DashboardSettings.tsx` - Added badge claim component
- `client/src/pages/DashboardPaymentDetails.tsx` - Added proof record component
- `client/src/components/PaymentsTable.tsx` - Added receipt status column
- `ENV_TEMPLATES.md` - Added contract address variables

## Testing Checklist

- [ ] Deploy contracts to ARC Testnet
- [ ] Set contract addresses in environment variables
- [ ] Test badge eligibility check
- [ ] Test badge minting flow
- [ ] Test proof hash generation
- [ ] Test proof recording flow
- [ ] Verify badge is non-transferable
- [ ] Verify proof is write-once
- [ ] Check dashboard displays correctly
- [ ] Verify explorer links work

## Next Steps

1. Deploy contracts to ARC Testnet
2. Set contract addresses in environment variables
3. Test end-to-end flows
4. Update IPFS metadata for badges
5. Consider adding contract verification on explorer
